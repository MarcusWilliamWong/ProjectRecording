<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<script src="https://cdn.socket.io/4.4.1/socket.io.min.js" integrity="sha384-fKnu0iswBIqkjxrhQCTZ7qlLHOFEgNkRmK2vaO/LbTZSXdJfAu6ewRBdwHPhBo/H" crossorigin="anonymous"></script>
	<title>Watcher</title>
	<style>
		video {
			width: 450px;
			height: 375px;
		}
	</style>
</head>
<body>
	<div style="text-align:center">
		<video id="thetaVideo" controls playsinline></video>
		<button id="forwardBtn" onclick="forwardCMD()">forward</button>
		<button id="backwardBtn" onclick="backwardCMD()">backwardBtn</button>
		<button id="leftwardBtn" onclick="leftwardCMD()">leftward</button>
		<button id="rightwardBtn" onclick="rightwardCMD()">rightwardBtn</button>
	</div>
	<script>
		let peerConnection; // 存储 peerConnection 对象
		const config = {iceServers: [{"urls": "stun:stun.l.google.com:19302"}]}; // WebRTC 配置
		// const config = {};

		const socket = io('ws://172.16.1.237:8010'); // 创建 Socket.IO 客户端
		// 5g ip
		// const socket = io.connect('ws://192.168.0.59:8010');
		// const socket = io.connect('ws://172.20.10.6:8010');

		const video = document.querySelector("video"); // 获取 video 元素

		// 监听 Socket.IO 的 connect 事件
		socket.on("connect", () => {
			// 与服务器建立连接时，告知服务器，连接进来的是直播客户端
			console.log("connected to server, local socket id:" + socket.id);
			socket.emit("newWatcher"); // 发送 watcher 事件给服务器
		});

		// 监听来自服务器的 broadcaster 事件
		socket.on("broadcaster", (broadcasterID) => {
			console.log("Notice: " + JSON.stringify(broadcasterID) + " broadcaster luanched live")
			socket.emit("watcher", socket.id, broadcasterID); // 发送 watcher 事件给服务器
		});

		// 监听来自服务器的 offer 事件
		socket.on("offer", (id, description) => {
			peerConnection = new RTCPeerConnection(config); // 创建新的 peerConnection 对象
			peerConnection
				.setRemoteDescription(description) // 设置远程描述
				.then(() => peerConnection.createAnswer()) // 创建 answer
				.then(sdp => peerConnection.setLocalDescription(sdp)) // 设置本地描述
				.then(() => {
					socket.emit("answer", id, peerConnection.localDescription); // 发送 answer 给服务器
				});
			peerConnection.ontrack = event => {
				video.srcObject = event.streams[0]; // 将视频流添加到 video 元素中

				video.onfullscreenerror = function () {
					console.log("cannot switch into full-screen mode");
				}
				video.onclick = function () {
					video.requestFullscreen();  // requestFullScreen必须用户来操作才能全屏
				};
			};
			peerConnection.onicecandidate = event => {
				if (event.candidate) {
					socket.emit("candidate", id, event.candidate); // 发送 ICE candidate 给服务器
				}
			};
		});

		// 监听来自服务器的 candidate 事件
		socket.on("candidate", (id, candidate) => {
			peerConnection
				.addIceCandidate(new RTCIceCandidate(candidate)) // 添加 ICE candidate
				.catch(e => console.error(e));
		});

		// 关闭 Socket.IO 连接和 peerConnection 对象
		window.onunload = window.onbeforeunload = () => {
			socket.close();
			peerConnection.close();
		};
	</script>
	
</body>
</html>